<section data-ng-controller="UserJobDetailsController"  data-ng-init="findOne()">
<section data-ng-controller="UserJobDetailsController"  data-ng-init="findOne()">

    <uib-alert type="{{alerts.type}}" close="alerts.close()" ng-show="alerts.visible" class="custom-alert">{{alerts.msg}}</uib-alert>

    <div class="row">
        <div class="col-lg-12">
            <h1>
                Detalle de trabajo
                <a data-ng-show="isJobApproved && isJobParticipant && hasJobNextStatuses &&
                                (!isJobInFinishedStatus ||
                                (isJobInFinishedStatus && isJobUser))"
                   ui-sref="jobs.edit({ jobId: job._id })" class="btn btn-success pull-right">Actualizar trabajo</a>


                <div class="btn-group" data-ng-show="isJobWaitingApproval && isJobApprover" uib-dropdown>
                    <button type="button" class="btn btn-default pull-right btn-report" uib-dropdown-toggle>
                        Aprovar/Rechazar trabajo<span class="caret"></span>
                    </button>
                    <ul class="uib-dropdown-menu" role="menu">
                        <li>
                            <a class="dropdown-item" data-ng-click="openApproveRejectJobModal('approved')">Aprobar trabajo</a>
                        </li>
                        <li>
                            <a class="dropdown-item" data-ng-click="openApproveRejectJobModal('rejected')">Rechazar trabajo</a>
                        </li>
                    </ul>
                </div>

                <div class="btn-group" data-ng-show="isJobChallenged && isAdmin"
                     uib-dropdown>
                    <button type="button" class="btn btn-default pull-right btn-report" uib-dropdown-toggle>
                        Resolver trabajo<span class="caret"></span>
                    </button>
                    <ul class="uib-dropdown-menu" role="menu">
                        <li>
                            <a class="dropdown-item" data-ng-click="openResolveJobModal('target')">Aceptar estado solicitado</a>
                        </li>
                        <li>
                            <a class="dropdown-item" data-ng-click="openResolveJobModal('challenge')">Aceptar estado desafiado</a>
                        </li>
                    </ul>
                </div>

                <a data-ng-disabled="true" ng-show="isJobWaitingApproval && isUserLastUpdater"
                   class="btn btn-info pull-right">Esperando aprobaci&#243;n</a>

                <!-- TODO: this should be displayed to both user and supplier only -->
                <!-- challenged jobs (unless with initial_approval_status == approved) should not be displayed to other users -->
                <a data-ng-disabled="true"
                   ng-show="isJobChallenged && (isJobParticipant || isAdmin)"
                   class="btn btn-danger pull-right">Pendiente de resoluci&#243;n</a>

                <a data-ng-show="isJobApproved && isJobUser && !isJobReviewed && isJobInFinishedStatus"
                   data-ng-click="openReviewModal()" class="btn btn-success pull-right">Agregar calificacion</a>
                <!-- TODO: consider different info to be displayed to other users, user and supplier -->

            </h1>
        </div>
        <div class="col-lg-12" style="color: gray; padding-bottom: 10px; font-size: 120%;">{{job.name}}</div>
    </div>

    <div class="row">

        <div class="col-md-6" data-ng-show="job.pictures.length">
            <uib-carousel interval="0" no-wrap="false" class="job-big-img">
                <uib-slide data-ng-repeat="slide in job.pictures" style="min-height: 260px;">
                    <img data-ng-src="{{slide}}" class="slide-container">
                </uib-slide>
            </uib-carousel>
        </div>

        <div class="col-md-6">
            <h3>Descripci&#243;n</h3>
            <p>{{job.description}}</p>
            <h3>Detalles</h3>
            <ul class="job-detail-list-container">
                <li data-ng-hide="isJobInNotHiredStatus"><strong>Fecha de inicio: </strong>{{job.start_date | date: 'shortDate'}}</li>
                <li data-ng-hide="isJobInNotHiredStatus || !isJobInFinishedStatus"><strong>Fecha de finalizaci&#243;n: </strong>{{job.finish_date ? job.finish_date : '-' | date: 'shortDate'}}</li>
                <li><strong>Estado actual: </strong>{{job.status.name}}</li>
                <li data-ng-show="hasJobStatusReason"><strong>Razon de estado: </strong>{{job.status_reason.description}}</li>
                <li data-ng-show="(isJobParticipant || isAdmin) && (isJobWaitingApproval || isJobChallenged)">
                    <strong>Estado solicitado: </strong>{{job.target_status.name}}
                </li>
                <li data-ng-show="(isJobParticipant || isAdmin) && (isJobWaitingApproval || isJobChallenged)
                                  && hasJobTargetStatusReason">
                    <strong>Razon de estado solicitada: </strong>{{job.target_status_reason.description}}
                </li>
                <li data-ng-show="(isJobParticipant || isAdmin) && isJobChallenged">
                    <strong>Estado desafiado: </strong>{{job.approval_challenge_details.status.name}}
                </li>
                <li data-ng-show="(isJobParticipant || isAdmin) && isJobChallengedWithStatusReason">
                    <strong>Razon de estado desafiada: </strong>{{job.approval_challenge_details.status_reason.description}}
                </li>
                <!-- TODO: add status reason challenged here: job.approval_challenge_details.status_reason.description -->
                <li>
                    <strong>Prestador de servicios: </strong>
                    <a ui-sref="servicesupplier.detail({ servicesupplierId: job.service_supplier._id })">{{job.service_supplier.display_name}}</a>
                </li>
                <li>
                    <strong>Cliente: </strong> {{job.user.displayName}}
                </li>
            </ul>
        </div>

    </div>

    <div class="row">

        <div class="col-lg-12">
            <br>
            <div class="upload-image-header-container">
                <div class="pull-right btn-upload-image">
                    <button data-ng-click="openUploadImagesModal()" type="button" class="btn btn-primary"
                            data-ng-show="isJobApproved && isJobParticipant">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Agregar im&#225;genes
                    </button>
                </div>

                <div class="job-images-label-container">Im&#225;genes del trabajo</div>
            </div>
            <br>
        </div>

        <div data-ng-repeat="picture in job.pictures" class="col-sm-3 col-xs-6 job-thumbnail">
            <a href="" data-ng-click="openImageModal(picture)">
                <img class="img-responsive job-small-img img-loading" data-ng-src="{{picture}}">
            </a>
        </div>

    </div>

    <div class="well" data-ng-show="!hasJobPictures">No hay im&#225;genes</div>

    <div class="row">

        <div class="col-lg-12">
            <br>
            <div class="service-supplier-header-container">
                <div class="reviews-label-container">Calificacion</div>
            </div>
            <br>
        </div>

    </div>

    <div class="well">
        <div data-ng-show="!isJobReviewed">El trabajo no ha sido calificado</div>
        <div class="row" data-ng-show="isJobReviewed">
            <div class="col-md-12">
                <br>
                <p>{{job.user.displayName}}
                <span class="pull-right">
                    <span class="glyphicon glyphicon-time"></span>
                    {{ job.review[0].created | date: 'medium' }}
                </span>
                </p>
                <p>
                    <uib-rating data-ng-model="job.review[0].ratingsAvg" max="max" readonly="true" on-hover="hoveringOver(value)" on-leave="overStar=null"></uib-rating>
                    <span>({{job.review[0].ratingsAvg}})</span>
                </p>
                <p>{{job.review[0].comment}}</p>
            </div>
        </div>
    </div>

    <script type="text/ng-template" id="addJobImagesModal">
        <div class="modal-header">
            <h3 class="modal-title">Agregar im&#225;genes</h3>
        </div>
        <div class="modal-body">

            <div ngf-drop ngf-select data-ng-model="files" class="drop-box" ngf-model-invalid="errFiles"
                 ngf-drag-over-class="dragover" ngf-multiple="true" ngf-allow-dir="true"
                 accept="image/*" ngf-max-size="4MB" ngf-pattern="'image/*'">Arrastra im&#225;genes aqui o haz click para cargar</div>

            <div class="job-img-upload-detail-container">
                <div data-ng-repeat="f in files" class="job-img-progres-container">
                    <div class="job-img-upload-thumbnail">
                        <img ngf-thumbnail="f" class="thumb"> {{f.name}}
                    </div>
                    <uib-progressbar class="progress-striped active" value="f.progress" type="warning" ng-show="f.progress >= 0">
                        <i ng-show="f.progress">{{f.progress}}%</i>
                    </uib-progressbar>
                </div>
                <li data-ng-repeat="f in errFiles" class="img-upload-error">{{f.name}} {{f.$error}} {{f.$errorParam}}
                </li>
            </div>

            <ul class="upload-requirements-container">
                <li>Tipos de im&#225;genes permitidas: JPG, PNG.</li>
                <li>El tama&#241;o debe ser menor a 4 MB.</li>
                <li>Usar bloqueadores de scripts puede hacer que falle la carga.</li>
            </ul>

        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" type="button" data-ng-click="uploadFiles(files)">Cargar</button>
            <button class="btn btn-default" type="button" data-ng-click="cancel()">Cancelar</button>
        </div>
    </script>

    <script type="text/ng-template" id="openImageModal">
        <div class="modal-body">
            <img class="img-responsive opened-img job-big-img" data-ng-src="{{image}}" alt="">
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" type="button" data-ng-click="delete()">Eliminar</button>
            <button class="btn btn-default" type="button" data-ng-click="close()">Cerrar</button>
        </div>
    </script>

    <script type="text/ng-template" id="approveRejectJobModal">
        <div class="modal-header">
            <h3 class="modal-title" data-ng-show="approvalAction == 'approved'">Aprobar trabajo</h3>
            <h3 class="modal-title" data-ng-show="approvalAction == 'rejected'">Rechazar trabajo</h3>
        </div>
        <div class="modal-body">

            <uib-alert type="{{alerts.type}}" close="alerts.close()" data-ng-show="alerts.visible">{{alerts.msg}}</uib-alert>

            <p>
                Est&#225;s seguro de que quieres {{approvalActionString}} el trabajo? <br>
            </p>
            <p data-ng-show="approvalAction == 'approved'">
                El trabajo pasar&#225; de estado '{{job.status.name}}' a estado '{{job.target_status.name}}'.
            </p>
            <p data-ng-show="approvalAction == 'rejected'">
                El estado del trabajo ser&#225; resuelto por un administrador del sistema. <br>
                Para ello, necesitamos que completes la siguiente informaci&#243;n:
            </p>

            <div data-ng-show="approvalAction == 'rejected'">
                <h4>Cual ser&#237;a actual del estado del trabajo en tu opini&#243;n?</h4>
                <div class="btn-group" uib-dropdown>
                    <button type="button" class="btn btn-default" uib-dropdown-toggle>
                        {{challengestatus.name}} <span class="caret"></span>
                    </button>
                    <ul class="uib-dropdown-menu" role="menu">
                        <li data-ng-repeat="challengestatus in possiblechallengestatuses">
                            <a class="dropdown-item" data-ng-click="changeChallengeStatus(challengestatus)">{{challengestatus.name}}</a>
                        </li>
                    </ul>
                </div>
                <br>
                <br>
                <textarea data-ng-model="challengecomment" class="form-control comments-text-area" cols="30" rows="4" placeholder="Deja un comentario aqui."></textarea>

            </div>

        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" type="button" data-ng-click="ok()">OK</button>
            <button class="btn btn-default" type="button" data-ng-click="cancel()">Cancelar</button>
        </div>
    </script>

    <script type="text/ng-template" id="resolveJobModal">
        <div class="modal-header">
            <h3 class="modal-title">Resolver trabajo</h3>
        </div>
        <div class="modal-body">

            <uib-alert type="{{alerts.type}}" close="alerts.close()" data-ng-show="alerts.visible">{{alerts.msg}}</uib-alert>
            <p>
                El trabajo quedar&#225; en estado {{resolvedJobStatus}}.<br>
                Est&#225;s seguro de aplicar el cambio?
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" type="button" data-ng-click="ok()">OK</button>
            <button class="btn btn-default" type="button" data-ng-click="cancel()">Cancelar</button>
        </div>
    </script>

</section>